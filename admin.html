<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Symptom Checker - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">
</head>
<body>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="app-card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Admin Dashboard</h3>
            <div>
              <button id="adminLoginBtn" class="btn btn-outline-light btn-sm">Sign in with Google</button>
              <button id="adminLogoutBtn" class="btn btn-outline-light btn-sm d-none">Sign out</button>
            </div>
          </div>

          <div id="adminArea" style="display:none;">
            <div class="mb-3">
              <h5>Manage Questions</h5>
              <form id="questionForm" class="row g-2">
                <div class="col-12">
                  <input id="qText" class="form-control" placeholder="Question text" />
                </div>
                <div class="col-12">
                  <textarea id="qOptions" class="form-control" placeholder='Options JSON, e.g. [{"text":"No","value":0},{"text":"Yes","value":2}]'></textarea>
                </div>
                <div class="col-auto">
                  <button id="addQBtn" class="btn btn-success">Add Question</button>
                </div>
                <div class="col-auto">
                  <button id="updateQBtn" class="btn btn-primary d-none">Update</button>
                </div>
                <div class="col-auto ms-auto">
                  <button id="refreshQs" class="btn btn-outline-light">Refresh</button>
                </div>
              </form>

              <div id="questionsList" class="mt-3"></div>
            </div>

            <hr />

            <div>
              <h5>Responses</h5>
              <div id="responsesList"></div>
              <div class="mt-3">
                <button id="exportAll" class="btn btn-outline-light btn-sm">Export CSV</button>
              </div>
            </div>

          </div>

          <div id="notAdminNotice" style="display:none;" class="small-muted">You are signed in but not an admin. Please add your email to the 'admins' collection in Firestore.</div>

        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, signInGoogle, signOutUser, isAdmin, addQuestion, fetchQuestions, deleteQuestion, updateQuestion, fetchResponses } from './firebase.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const adminArea = document.getElementById('adminArea');
    const notAdminNotice = document.getElementById('notAdminNotice');
    const questionForm = document.getElementById('questionForm');
    const qText = document.getElementById('qText');
    const qOptions = document.getElementById('qOptions');
    const addQBtn = document.getElementById('addQBtn');
    const updateQBtn = document.getElementById('updateQBtn');
    const questionsList = document.getElementById('questionsList');
    const refreshQs = document.getElementById('refreshQs');
    const responsesList = document.getElementById('responsesList');
    const exportAll = document.getElementById('exportAll');

    let editId = null;

    adminLoginBtn.addEventListener('click', async ()=>{ await signInGoogle(); });
    adminLogoutBtn.addEventListener('click', async ()=>{ await signOutUser(); });

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        adminLoginBtn.classList.add('d-none');
        adminLogoutBtn.classList.remove('d-none');
        const email = user.email;
        const ok = await isAdmin(email);
        if(ok){
          adminArea.style.display = 'block';
          notAdminNotice.style.display = 'none';
          await loadQuestions();
          await loadResponses();
        } else {
          adminArea.style.display = 'none';
          notAdminNotice.style.display = 'block';
        }
      } else {
        adminLoginBtn.classList.remove('d-none');
        adminLogoutBtn.classList.add('d-none');
        adminArea.style.display = 'none';
        notAdminNotice.style.display = 'none';
      }
    });

    async function loadQuestions(){
      const qs = await fetchQuestions();
      questionsList.innerHTML = '';
      qs.forEach(q=>{
        const el = document.createElement('div');
        el.className = 'p-2 mb-2 border rounded';
        el.innerHTML = `<div class="d-flex align-items-start justify-content-between"><div><strong>${q.text}</strong><div class="small-muted">id: ${q.id}</div></div><div class="btn-group"> <button data-id="${q.id}" class="btn btn-sm btn-outline-light editQ">Edit</button> <button data-id="${q.id}" class="btn btn-sm btn-outline-danger delQ">Delete</button></div></div>`;
        questionsList.appendChild(el);
      });

      // attach handlers
      questionsList.querySelectorAll('.delQ').forEach(b=> b.addEventListener('click', async (e)=>{
        const id = e.target.dataset.id;
        if(confirm('Delete this question?')){ await deleteQuestion(id); await loadQuestions(); }
      }));

      questionsList.querySelectorAll('.editQ').forEach(b=> b.addEventListener('click', async (e)=>{
        const id = e.target.dataset.id;
        const qs = await fetchQuestions();
        const q = qs.find(x=>x.id===id);
        if(q){ editId = id; qText.value = q.text; qOptions.value = JSON.stringify(q.options, null, 2); addQBtn.classList.add('d-none'); updateQBtn.classList.remove('d-none'); }
      }));
    }

    addQBtn.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      try{
        const options = JSON.parse(qOptions.value);
        await addQuestion({ text: qText.value, options });
        qText.value = ''; qOptions.value = '';
        await loadQuestions();
      }catch(err){ alert('Invalid options JSON'); }
    });

    updateQBtn.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      if(!editId) return;
      try{
        const options = JSON.parse(qOptions.value);
        await updateQuestion(editId, { text: qText.value, options });
        editId = null; qText.value = ''; qOptions.value = '';
        addQBtn.classList.remove('d-none'); updateQBtn.classList.add('d-none');
        await loadQuestions();
      }catch(err){ alert('Invalid options JSON'); }
    });

    refreshQs.addEventListener('click', async (ev)=>{ ev.preventDefault(); await loadQuestions(); });

    async function loadResponses(){
      const res = await fetchResponses();
      responsesList.innerHTML = '';
      res.forEach(r=>{
        const el = document.createElement('div');
        el.className = 'p-2 mb-2 border rounded';
        el.innerHTML = `<div class="d-flex justify-content-between"><div><strong>${r.name} (${r.email})</strong><div class="small-muted">Age: ${r.age} — ${r.severity} — ${new Date(r.createdAt?.seconds ? r.createdAt.seconds*1000 : r.timestamp).toLocaleString()}</div></div></div><details><summary>Answers</summary><pre>${JSON.stringify(r.answers, null, 2)}</pre></details>`;
        responsesList.appendChild(el);
      });
    }

    exportAll.addEventListener('click', async ()=>{
      const res = await fetchResponses();
      // build CSV
      let csv = 'name,email,age,severity,totalScore,timestamp,answers\n';
      res.forEach(r=>{
        const answers = JSON.stringify(r.answers).replace(/"/g,'""');
        const ts = r.createdAt?.seconds ? new Date(r.createdAt.seconds*1000).toISOString() : (r.timestamp || '');
        csv += `"${r.name}","${r.email}","${r.age}","${r.severity}","${r.totalScore || ''}","${ts}","${answers}"\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'responses.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
